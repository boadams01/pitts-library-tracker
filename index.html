<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pitts Theology Library ‚Äî Patron Traffic</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Source+Sans+3:wght@300;400;600&display=swap');

  :root {
    --ink: #1a1209;
    --parchment: #f5f0e8;
    --warm-mid: #e8dfc8;
    --accent: #8b3a15;
    --accent-light: #c4622d;
    --gold: #b8922a;
    --muted: #7a6e5f;
    --card-bg: #faf7f0;
    --border: #d4c8b0;
    --success: #2d6a4f;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Source Sans 3', sans-serif;
    background: var(--parchment);
    color: var(--ink);
    min-height: 100vh;
    background-image: 
      radial-gradient(ellipse at 20% 50%, rgba(139,58,21,0.04) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 20%, rgba(184,146,42,0.05) 0%, transparent 50%);
  }

  header {
    background: var(--ink);
    color: var(--parchment);
    padding: 2rem 3rem;
    border-bottom: 4px solid var(--gold);
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    gap: 1rem;
  }

  .header-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.9rem;
    font-weight: 900;
    letter-spacing: 0.01em;
    line-height: 1.1;
  }

  .header-subtitle {
    font-size: 0.8rem;
    color: var(--gold);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-top: 0.3rem;
    font-weight: 300;
  }

  .nav-tabs {
    display: flex;
    gap: 0.25rem;
    background: rgba(255,255,255,0.05);
    border-radius: 6px;
    padding: 4px;
  }

  .nav-tab {
    padding: 0.4rem 1rem;
    border: none;
    background: transparent;
    color: rgba(245,240,232,0.6);
    cursor: pointer;
    border-radius: 4px;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.85rem;
    letter-spacing: 0.05em;
    transition: all 0.2s;
  }

  .nav-tab.active {
    background: var(--accent);
    color: var(--parchment);
  }

  .nav-tab:hover:not(.active) {
    color: var(--parchment);
    background: rgba(255,255,255,0.1);
  }

  .container { max-width: 1200px; margin: 0 auto; padding: 2rem 3rem; }

  /* VIEWS */
  .view { display: none; }
  .view.active { display: block; }

  /* IMPORT VIEW */
  .import-area {
    border: 2px dashed var(--border);
    border-radius: 8px;
    padding: 3rem;
    text-align: center;
    background: var(--card-bg);
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 2rem;
    position: relative;
  }

  .import-area:hover, .import-area.drag-over {
    border-color: var(--accent);
    background: rgba(139,58,21,0.03);
  }

  .import-area input[type=file] {
    position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
  }

  .import-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    display: block;
  }

  .import-area h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    margin-bottom: 0.5rem;
  }

  .import-area p { color: var(--muted); font-size: 0.9rem; }

  textarea#paste-area {
    width: 100%;
    height: 200px;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 1rem;
    font-family: monospace;
    font-size: 0.8rem;
    background: var(--card-bg);
    color: var(--ink);
    resize: vertical;
    margin-bottom: 1rem;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.65rem 1.5rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    transition: all 0.15s;
  }

  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: var(--accent-light); }
  .btn-secondary { background: var(--warm-mid); color: var(--ink); }
  .btn-secondary:hover { background: var(--border); }
  .btn-gold { background: var(--gold); color: white; }
  .btn-gold:hover { filter: brightness(1.1); }

  .parse-preview {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 1.5rem;
    display: none;
  }

  .parse-preview h4 {
    font-family: 'Playfair Display', serif;
    margin-bottom: 1rem;
    color: var(--success);
  }

  .preview-row {
    display: flex;
    justify-content: space-between;
    padding: 0.4rem 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.9rem;
  }

  .preview-row:last-child { border-bottom: none; }
  .preview-cat { color: var(--muted); }
  .preview-count { font-weight: 600; }

  /* DASHBOARD */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.25rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
    position: relative;
    overflow: hidden;
    animation: fadeUp 0.4s ease both;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: var(--accent);
  }

  .stat-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
    margin-bottom: 0.5rem;
  }

  .stat-value {
    font-family: 'Playfair Display', serif;
    font-size: 2.2rem;
    font-weight: 700;
    color: var(--ink);
    line-height: 1;
  }

  .stat-sub { font-size: 0.8rem; color: var(--muted); margin-top: 0.4rem; }
  .stat-delta { font-weight: 600; }
  .delta-up { color: var(--success); }
  .delta-down { color: var(--accent); }

  .charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  @media (max-width: 800px) {
    .charts-grid { grid-template-columns: 1fr; }
    .container { padding: 1.5rem; }
    header { padding: 1.5rem; flex-direction: column; align-items: flex-start; }
  }

  .chart-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
  }

  .chart-card h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--ink);
  }

  .chart-card canvas { max-height: 260px; }

  /* DATA TABLE */
  .table-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  select, input[type=text] {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: 5px;
    background: var(--card-bg);
    font-family: 'Source Sans 3', sans-serif;
    font-size: 0.9rem;
    color: var(--ink);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: var(--card-bg);
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--border);
    font-size: 0.88rem;
  }

  th {
    background: var(--ink);
    color: var(--parchment);
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 600;
    letter-spacing: 0.05em;
    font-size: 0.78rem;
    text-transform: uppercase;
  }

  td { padding: 0.65rem 1rem; border-bottom: 1px solid var(--border); }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(139,58,21,0.03); }

  .cat-badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 600;
    background: var(--warm-mid);
    color: var(--accent);
    letter-spacing: 0.05em;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--muted);
  }

  .empty-state h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    margin-bottom: 0.5rem;
    color: var(--ink);
  }

  .section-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    margin-bottom: 1.25rem;
    color: var(--ink);
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .alert {
    padding: 0.75rem 1rem;
    border-radius: 5px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
  }

  .alert-success { background: rgba(45,106,79,0.1); color: var(--success); border: 1px solid rgba(45,106,79,0.2); }
  .alert-error { background: rgba(139,58,21,0.1); color: var(--accent); border: 1px solid rgba(139,58,21,0.2); }

  .filter-row { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; margin-bottom: 1.5rem; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .week-entry {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .week-info h4 { font-family: 'Playfair Display', serif; font-size: 1rem; }
  .week-info p { font-size: 0.8rem; color: var(--muted); margin-top: 0.15rem; }
  .week-total { font-family: 'Playfair Display', serif; font-size: 1.5rem; font-weight: 700; color: var(--accent); }

  .delete-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--muted);
    cursor: pointer;
    padding: 0.3rem 0.6rem;
    font-size: 0.8rem;
    transition: all 0.15s;
  }
  .delete-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* SETTINGS */
  .cat-editor-row {
    display: grid;
    grid-template-columns: 80px 1fr 1fr auto;
    gap: 0.75rem;
    align-items: center;
    padding: 0.6rem 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.9rem;
  }
  .cat-editor-row:last-child { border-bottom: none; }
  .cat-id { font-family: monospace; font-size: 0.8rem; color: var(--muted); }
  .cat-original { color: var(--muted); font-size: 0.85rem; }
  .cat-name-input {
    padding: 0.4rem 0.6rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--parchment);
    font-family: "Source Sans 3", sans-serif;
    font-size: 0.88rem;
    color: var(--ink);
    width: 100%;
  }
  .cat-name-input:focus { outline: none; border-color: var(--accent); }
  .cat-editor-header {
    display: grid;
    grid-template-columns: 80px 1fr 1fr auto;
    gap: 0.75rem;
    padding: 0.5rem 0;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
    border-bottom: 2px solid var(--border);
    margin-bottom: 0.25rem;
  }
  .new-cat-row {
    display: grid;
    grid-template-columns: 80px 1fr 1fr auto;
    gap: 0.75rem;
    align-items: center;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 2px dashed var(--border);
  }
  .new-cat-row input { padding: 0.4rem 0.6rem; border: 1px solid var(--border); border-radius: 4px; background: var(--parchment); font-family: "Source Sans 3", sans-serif; font-size: 0.88rem; color: var(--ink); width: 100%; }
  .new-cat-row input:focus { outline: none; border-color: var(--accent); }
  .settings-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; }
  .settings-note { font-size: 0.82rem; color: var(--muted); margin-bottom: 1.25rem; line-height: 1.5; }
</style>
</head>
<body>

<header>
  <div>
    <div class="header-title">Pitts Theology Library</div>
    <div class="header-subtitle">Patron Traffic Dashboard ¬∑ Location #00055</div>
  </div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchView('dashboard')">Dashboard</button>
    <button class="nav-tab" onclick="switchView('import')">Import Report</button>
    <button class="nav-tab" onclick="switchView('data')">Data &amp; Export</button>
    <button class="nav-tab" onclick="switchView('settings')">‚öô Settings</button>
  </div>
</header>

<div class="container">

  <!-- DASHBOARD VIEW -->
  <div class="view active" id="view-dashboard">
    <div id="dash-empty" class="empty-state" style="display:none">
      <h3>No data imported yet</h3>
      <p>Go to <strong>Import Report</strong> to upload your first weekly report.</p>
    </div>
    <div id="dash-content">
      <div class="stats-grid" id="stats-grid"></div>
      <div class="filter-row">
        <label style="font-size:0.85rem;color:var(--muted)">Filter by year:</label>
        <select id="year-filter" onchange="renderDashboard()"><option value="all">All Years</option></select>
      </div>
      <div class="charts-grid">
        <div class="chart-card">
          <h3>Weekly Visits Over Time</h3>
          <canvas id="chart-trend"></canvas>
        </div>
        <div class="chart-card">
          <h3>Patron Categories (Latest Week)</h3>
          <canvas id="chart-categories"></canvas>
        </div>
        <div class="chart-card">
          <h3>Monthly Totals</h3>
          <canvas id="chart-monthly"></canvas>
        </div>
        <div class="chart-card">
          <h3>Year-over-Year Comparison</h3>
          <canvas id="chart-yoy"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- IMPORT VIEW -->
  <div class="view" id="view-import">
    <div class="section-title">Import Weekly Report</div>
    
    <div class="import-area" id="drop-zone">
      <input type="file" accept=".txt" multiple onchange="handleFileInput(this)">
      <span class="import-icon">üìÑ</span>
      <h3>Drop your .txt report files here</h3>
      <p>or click to browse ‚Äî select multiple files at once from your folder</p>
    </div>

    <div style="text-align:center;color:var(--muted);margin:-0.5rem 0 1rem;font-size:0.85rem">‚Äî or paste the report text below ‚Äî</div>

    <textarea id="paste-area" placeholder="Paste the contents of your weekly report here..."></textarea>

    <div style="display:flex;gap:0.75rem">
      <button class="btn btn-primary" onclick="parseAndPreview()">Parse Report</button>
      <button class="btn btn-secondary" onclick="clearImport()">Clear</button>
    </div>

    <div id="alert-area"></div>

    <div class="parse-preview" id="parse-preview">
      <h4 id="preview-title">‚úì Report Parsed Successfully</h4>
      <div id="preview-week-info" style="margin-bottom:1rem;font-size:0.9rem;color:var(--muted)"></div>
      <div id="preview-rows"></div>
      <div style="margin-top:1.25rem;display:flex;gap:0.75rem">
        <button class="btn btn-gold" onclick="saveReport()">Save to Database</button>
        <button class="btn btn-secondary" onclick="document.getElementById('parse-preview').style.display='none'">Cancel</button>
      </div>
    </div>
  </div>

  <!-- DATA VIEW -->
  <div class="view" id="view-data">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
      <div class="section-title" style="margin:0">Stored Reports</div>
      <button class="btn btn-gold" onclick="exportCSV()">‚¨á Export CSV</button>
    </div>

    <div id="weeks-list"></div>

    <div class="section-title" style="margin-top:2rem">Detailed Category Data</div>
    <div class="table-controls">
      <select id="table-year" onchange="renderTable()"><option value="all">All Years</option></select>
      <select id="table-category" onchange="renderTable()"><option value="all">All Categories</option></select>
    </div>
    <div style="overflow-x:auto">
      <table id="data-table">
        <thead>
          <tr>
            <th>Week Of</th>
            <th>Category</th>
            <th>Accesses</th>
            <th>Week Total</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>

  <!-- SETTINGS VIEW -->
  <div class="view" id="view-settings">
    <div class="section-title">Category Name Settings</div>
    <div class="settings-card">
      <p class="settings-note">
        These names are applied when importing reports. Categories discovered in future reports that aren't listed here will be added automatically with their original names ‚Äî you can rename them here at any time. Changes take effect on the next import.
      </p>
      <div class="cat-editor-header">
        <span>Cat. ID</span><span>Original Name</span><span>Display Name</span><span></span>
      </div>
      <div id="cat-editor-list"></div>
      <div class="new-cat-row">
        <input type="number" id="new-cat-id" placeholder="ID #" min="0">
        <input type="text" id="new-cat-original" placeholder="Original name from report">
        <input type="text" id="new-cat-display" placeholder="Friendly display name">
        <button class="btn btn-primary" onclick="addCatMapping()" style="white-space:nowrap;padding:0.4rem 1rem">+ Add</button>
      </div>
    </div>
    <div style="display:flex;gap:0.75rem">
      <button class="btn btn-gold" onclick="saveCatMappings()">Save Changes</button>
      <button class="btn btn-secondary" onclick="renderSettings()">Discard</button>
    </div>
    <div id="settings-alert"></div>
  </div>

</div>

<script>
// ‚îÄ‚îÄ Storage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DB_KEY = 'pitts_library_data';

function loadDB() {
  try { return JSON.parse(localStorage.getItem(DB_KEY) || '[]'); } 
  catch { return []; }
}

function saveDB(data) {
  localStorage.setItem(DB_KEY, JSON.stringify(data));
}

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  event.target.classList.add('active');
  if (name === 'dashboard') renderDashboard();
  if (name === 'data') renderData();
  if (name === 'settings') renderSettings();
}

// ‚îÄ‚îÄ Parsing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pendingReport = null;

function parseReport(text) {
  // Extract date range
  const dateMatch = text.match(/Beginning:\s*(\d{2}\/\d{2}\/\d{4})/);
  const endMatch = text.match(/Ending:\s*(\d{2}\/\d{2}\/\d{4})/);
  if (!dateMatch) throw new Error('Could not find date range in report.');

  const weekStart = dateMatch[1];
  const weekEnd = endMatch ? endMatch[1] : null;

  // Extract categories
  const catRegex = /ACCESS CATEGORY #\s*(\d+) --> (.+?)\nEND ACCESS CATEGORY #\s*\1 ---> .*?= (\d+) ACCESSES/g;
  const categories = [];
  let match;
  const catNames = loadCatNames();
  while ((match = catRegex.exec(text)) !== null) {
    const id = parseInt(match[1]);
    const rawName = match[2].trim();
    // Use user-defined display name if set, otherwise use raw name from report
    let name = resolveName(id, rawName);
    const count = parseInt(match[3]);
    categories.push({ id, name, count });
    // Auto-register unknown categories so they appear in settings
    if (!catNames[id]) {
      catNames[id] = { original: rawName, display: rawName };
      localStorage.setItem(NAMES_KEY, JSON.stringify(catNames));
    }
  }

  if (categories.length === 0) throw new Error('No category data found. Please check the report format.');

  const totalMatch = text.match(/END REPORT - (\d+) ACCESSES/);
  const total = totalMatch ? parseInt(totalMatch[1]) : categories.reduce((s, c) => s + c.count, 0);

  return { weekStart, weekEnd, categories, total };
}

function handleFileInput(input) {
  const files = Array.from(input.files);
  if (!files.length) return;
  if (files.length === 1) {
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('paste-area').value = e.target.result;
      parseAndPreview();
    };
    reader.readAsText(files[0]);
  } else {
    importMultipleFiles(files);
  }
}

function parseAndPreview() {
  const text = document.getElementById('paste-area').value.trim();
  if (!text) { showAlert('Please paste or upload a report first.', 'error'); return; }

  try {
    const report = parseReport(text);
    pendingReport = report;

    document.getElementById('preview-title').textContent = '‚úì Report Parsed Successfully';
    document.getElementById('preview-week-info').textContent =
      `Week: ${report.weekStart}${report.weekEnd ? ' ‚Äì ' + report.weekEnd : ''} ¬∑ Total: ${report.total.toLocaleString()} accesses`;

    const rows = document.getElementById('preview-rows');
    rows.innerHTML = report.categories.map(c => `
      <div class="preview-row">
        <span class="preview-cat">${c.name}</span>
        <span class="preview-count">${c.count.toLocaleString()}</span>
      </div>`).join('');

    document.getElementById('parse-preview').style.display = 'block';
    document.getElementById('alert-area').innerHTML = '';
  } catch(e) {
    showAlert(e.message, 'error');
  }
}

function saveReport() {
  if (!pendingReport) return;
  const db = loadDB();

  const dup = db.find(r => r.weekStart === pendingReport.weekStart);
  if (dup) {
    showAlert(`A report for the week of ${pendingReport.weekStart} already exists. Delete it from the Data tab first if you want to replace it.`, 'error');
    return;
  }

  db.push({ ...pendingReport, savedAt: new Date().toISOString() });
  db.sort((a, b) => new Date(a.weekStart) - new Date(b.weekStart));
  saveDB(db);

  showAlert('Report saved successfully!', 'success');
  document.getElementById('parse-preview').style.display = 'none';
  document.getElementById('paste-area').value = '';
  pendingReport = null;
}

function importMultipleFiles(files) {
  document.getElementById('parse-preview').style.display = 'none';
  document.getElementById('alert-area').innerHTML =
    `<div class="alert alert-success" style="margin-top:1rem">‚è≥ Reading ${files.length} files...</div>`;

  const readers = files.map(file => new Promise((resolve) => {
    const r = new FileReader();
    r.onload = e => resolve({ name: file.name, text: e.target.result });
    r.onerror = () => resolve({ name: file.name, error: 'Could not read file' });
    r.readAsText(file);
  }));

  Promise.all(readers).then(results => {
    const db = loadDB();
    let imported = 0, skipped = 0, failed = 0;
    const skipList = [], failList = [];

    results.forEach(({ name, text, error }) => {
      if (error) { failed++; failList.push(name); return; }
      try {
        const report = parseReport(text);
        if (db.find(r => r.weekStart === report.weekStart)) {
          skipped++;
          skipList.push(report.weekStart);
          return;
        }
        db.push({ ...report, savedAt: new Date().toISOString() });
        imported++;
      } catch(e) {
        failed++;
        failList.push(name);
      }
    });

    db.sort((a, b) => new Date(a.weekStart) - new Date(b.weekStart));
    saveDB(db);

    let msg = `‚úì Imported <strong>${imported}</strong> report${imported !== 1 ? 's' : ''}.`;
    if (skipped) msg += ` <strong>${skipped}</strong> skipped (already in database).`;
    if (failed) msg += ` <strong>${failed}</strong> failed to parse.`;
    if (failList.length) msg += `<br><small style="opacity:0.7">Failed: ${failList.join(', ')}</small>`;

    document.getElementById('alert-area').innerHTML =
      `<div class="alert alert-${failed && !imported ? 'error' : 'success'}" style="margin-top:1rem">${msg}</div>`;
  });
}

function clearImport() {
  document.getElementById('paste-area').value = '';
  document.getElementById('parse-preview').style.display = 'none';
  document.getElementById('alert-area').innerHTML = '';
  pendingReport = null;
}

function showAlert(msg, type) {
  document.getElementById('alert-area').innerHTML =
    `<div class="alert alert-${type}" style="margin-top:1rem">${msg}</div>`;
}

// ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let charts = {};

function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

const COLORS = ['#8b3a15','#b8922a','#2d6a4f','#3a4a8b','#7a3a8b','#3a8b7a','#8b7a3a','#5a3a8b','#8b3a6a','#3a6a8b'];

function renderDashboard() {
  const db = loadDB();

  // Populate year filter
  const yearSel = document.getElementById('year-filter');
  const years = [...new Set(db.map(r => r.weekStart.split('/')[2]))].sort();
  const currentYear = yearSel.value;
  yearSel.innerHTML = '<option value="all">All Years</option>' + years.map(y => `<option value="${y}" ${y===currentYear?'selected':''}>${y}</option>`).join('');

  const filtered = currentYear && currentYear !== 'all'
    ? db.filter(r => r.weekStart.split('/')[2] === currentYear) : db;

  if (db.length === 0) {
    document.getElementById('dash-empty').style.display = 'block';
    document.getElementById('dash-content').style.display = 'none';
    return;
  }
  document.getElementById('dash-empty').style.display = 'none';
  document.getElementById('dash-content').style.display = 'block';

  // Stats
  const latest = filtered[filtered.length - 1];
  const prev = filtered[filtered.length - 2];
  const totalAll = filtered.reduce((s, r) => s + r.total, 0);
  const avgWeek = Math.round(totalAll / (filtered.length || 1));
  const delta = latest && prev ? latest.total - prev.total : null;

  const grid = document.getElementById('stats-grid');
  grid.innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Latest Week Total</div>
      <div class="stat-value">${latest ? latest.total.toLocaleString() : '‚Äî'}</div>
      ${delta !== null ? `<div class="stat-sub stat-delta ${delta>=0?'delta-up':'delta-down'}">${delta>=0?'‚ñ≤':'‚ñº'} ${Math.abs(delta).toLocaleString()} vs prior week</div>` : ''}
    </div>
    <div class="stat-card">
      <div class="stat-label">Average Weekly</div>
      <div class="stat-value">${avgWeek.toLocaleString()}</div>
      <div class="stat-sub">${filtered.length} weeks on record</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Visits (${currentYear !== 'all' && currentYear ? currentYear : 'All Time'})</div>
      <div class="stat-value">${totalAll.toLocaleString()}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Top Category (Latest)</div>
      <div class="stat-value" style="font-size:1.4rem">${latest ? getTopCat(latest) : '‚Äî'}</div>
      ${latest ? `<div class="stat-sub">${latest.categories.find(c=>c.name===getTopCat(latest))?.count.toLocaleString()} accesses</div>` : ''}
    </div>`;

  // Trend chart
  destroyChart('trend');
  charts['trend'] = new Chart(document.getElementById('chart-trend'), {
    type: 'line',
    data: {
      labels: filtered.map(r => r.weekStart),
      datasets: [{
        label: 'Total Accesses',
        data: filtered.map(r => r.total),
        borderColor: '#8b3a15',
        backgroundColor: 'rgba(139,58,21,0.08)',
        fill: true,
        tension: 0.3,
        pointBackgroundColor: '#8b3a15',
        pointRadius: 4
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } }
  });

  // Category pie (latest)
  destroyChart('categories');
  if (latest) {
    const cats = latest.categories.filter(c => c.count > 0);
    charts['categories'] = new Chart(document.getElementById('chart-categories'), {
      type: 'doughnut',
      data: {
        labels: cats.map(c => c.name),
        datasets: [{ data: cats.map(c => c.count), backgroundColor: COLORS }]
      },
      options: { responsive: true, plugins: { legend: { position: 'right', labels: { font: { size: 11 } } } } }
    });
  }

  // Monthly totals
  const monthly = {};
  filtered.forEach(r => {
    const [m,,y] = r.weekStart.split('/');
    const key = `${y}-${m.padStart(2,'0')}`;
    monthly[key] = (monthly[key] || 0) + r.total;
  });
  const mKeys = Object.keys(monthly).sort();
  destroyChart('monthly');
  charts['monthly'] = new Chart(document.getElementById('chart-monthly'), {
    type: 'bar',
    data: {
      labels: mKeys.map(k => { const [y,m] = k.split('-'); return new Date(y,m-1).toLocaleString('default',{month:'short',year:'2-digit'}); }),
      datasets: [{ label: 'Monthly Total', data: mKeys.map(k => monthly[k]), backgroundColor: '#b8922a', borderRadius: 4 }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });

  // YoY
  const yoyData = {};
  db.forEach(r => {
    const [m,,y] = r.weekStart.split('/');
    if (!yoyData[y]) yoyData[y] = {};
    const mKey = parseInt(m);
    yoyData[y][mKey] = (yoyData[y][mKey] || 0) + r.total;
  });
  const allYears = Object.keys(yoyData).sort();
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  destroyChart('yoy');
  charts['yoy'] = new Chart(document.getElementById('chart-yoy'), {
    type: 'line',
    data: {
      labels: months,
      datasets: allYears.map((yr, i) => ({
        label: yr,
        data: months.map((_, mi) => yoyData[yr][mi+1] || null),
        borderColor: COLORS[i % COLORS.length],
        backgroundColor: 'transparent',
        tension: 0.3,
        pointRadius: 3,
        spanGaps: false
      }))
    },
    options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
  });
}

function getTopCat(report) {
  return report.categories.reduce((a, b) => b.count > a.count ? b : a, { count: -1, name: '‚Äî' }).name;
}

// ‚îÄ‚îÄ Data View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderData() {
  const db = loadDB();

  // Weeks list
  const list = document.getElementById('weeks-list');
  if (db.length === 0) {
    list.innerHTML = '<div class="empty-state"><h3>No reports imported yet</h3><p>Go to Import Report to add data.</p></div>';
  } else {
    list.innerHTML = [...db].reverse().map(r => `
      <div class="week-entry">
        <div class="week-info">
          <h4>Week of ${r.weekStart}${r.weekEnd ? ' ‚Äì ' + r.weekEnd : ''}</h4>
          <p>${r.categories.length} categories ¬∑ Saved ${new Date(r.savedAt).toLocaleDateString()}</p>
        </div>
        <div class="week-total">${r.total.toLocaleString()}</div>
        <button class="delete-btn" onclick="deleteReport('${r.weekStart}')">üóë Delete</button>
      </div>`).join('');
  }

  // Populate filters
  const years = [...new Set(db.map(r => r.weekStart.split('/')[2]))].sort();
  const cats = [...new Set(db.flatMap(r => r.categories.map(c => c.name)))].sort();

  const ySel = document.getElementById('table-year');
  const cSel = document.getElementById('table-category');
  const cy = ySel.value, cc = cSel.value;
  ySel.innerHTML = '<option value="all">All Years</option>' + years.map(y => `<option value="${y}" ${y===cy?'selected':''}>${y}</option>`).join('');
  cSel.innerHTML = '<option value="all">All Categories</option>' + cats.map(c => `<option value="${c}" ${c===cc?'selected':''}>${c}</option>`).join('');

  renderTable();
}

function renderTable() {
  const db = loadDB();
  const yr = document.getElementById('table-year').value;
  const cat = document.getElementById('table-category').value;

  let rows = [];
  db.forEach(r => {
    if (yr !== 'all' && r.weekStart.split('/')[2] !== yr) return;
    r.categories.forEach(c => {
      if (cat !== 'all' && c.name !== cat) return;
      rows.push({ weekStart: r.weekStart, category: c.name, count: c.count, total: r.total });
    });
  });

  document.getElementById('table-body').innerHTML = rows.length === 0
    ? `<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:2rem">No data</td></tr>`
    : rows.map(r => `<tr>
        <td>${r.weekStart}</td>
        <td><span class="cat-badge">${r.category}</span></td>
        <td>${r.count.toLocaleString()}</td>
        <td>${r.total.toLocaleString()}</td>
      </tr>`).join('');
}

function deleteReport(weekStart) {
  if (!confirm(`Delete the report for week of ${weekStart}?`)) return;
  const db = loadDB().filter(r => r.weekStart !== weekStart);
  saveDB(db);
  renderData();
}

// ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportCSV() {
  const db = loadDB();
  if (db.length === 0) { alert('No data to export.'); return; }

  const rows = [['Week Start', 'Week End', 'Category', 'Category ID', 'Accesses', 'Week Total']];
  db.forEach(r => {
    r.categories.forEach(c => {
      rows.push([r.weekStart, r.weekEnd || '', c.name, c.id, c.count, r.total]);
    });
  });

  const csv = rows.map(r => r.map(v => `"${v}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
  a.download = `pitts_library_traffic_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

// ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const dz = document.getElementById('drop-zone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
dz.addEventListener('drop', e => {
  e.preventDefault();
  dz.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.txt'));
  if (files.length === 1) {
    const r = new FileReader();
    r.onload = ev => { document.getElementById('paste-area').value = ev.target.result; parseAndPreview(); };
    r.readAsText(files[0]);
  } else if (files.length > 1) {
    importMultipleFiles(files);
  }
});


// ‚îÄ‚îÄ Category Name Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NAMES_KEY = 'pitts_cat_names';

const DEFAULT_NAMES = {
  0:    { original: '',                        display: 'Pitts Staff' },
  13:   { original: 'GBUS (Graduate B. Sch)',  display: 'Graduate Business School' },
  14:   { original: 'UCOL (College)',           display: 'Emory College' },
  16:   { original: 'GSAS (Grad Sch)',          display: 'Laney Graduate School' },
  17:   { original: 'LAW (Law School)',         display: 'Law School' },
  18:   { original: 'MED (Visiting Med Student)', display: 'Medical School' },
  19:   { original: 'UNUR (Nursing)',           display: 'Undergraduate Nursing' },
  20:   { original: 'THEO (Theology)',          display: 'Candler School of Theology' },
  21:   { original: 'UOXF (Oxford)',            display: 'Oxford' },
  578:  { original: 'ALUMNI',                  display: 'Emory Alumni' },
  1778: { original: 'No Access Control Status', display: 'Other' },
};

function loadCatNames() {
  try {
    const stored = JSON.parse(localStorage.getItem(NAMES_KEY));
    if (stored) return stored;
  } catch {}
  // First run: seed from defaults
  const seed = {};
  Object.entries(DEFAULT_NAMES).forEach(([id, v]) => { seed[id] = { ...v }; });
  localStorage.setItem(NAMES_KEY, JSON.stringify(seed));
  return seed;
}

function resolveName(id, rawName) {
  const names = loadCatNames();
  const entry = names[id];
  if (entry && entry.display) return entry.display;
  return rawName || 'Unknown';
}

// Track pending edits
let pendingMappings = null;

function renderSettings() {
  const names = loadCatNames();
  pendingMappings = JSON.parse(JSON.stringify(names)); // deep copy

  const list = document.getElementById('cat-editor-list');
  list.innerHTML = Object.entries(pendingMappings)
    .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))
    .map(([id, v]) => `
      <div class="cat-editor-row" id="row-${id}">
        <span class="cat-id">#${id}</span>
        <span class="cat-original">${v.original || '(blank)'}</span>
        <input class="cat-name-input" type="text" value="${v.display}" data-id="${id}" oninput="updatePending(this)">
        <button class="delete-btn" onclick="removeCatRow(${id})">‚úï</button>
      </div>`).join('');

  document.getElementById('new-cat-id').value = '';
  document.getElementById('new-cat-original').value = '';
  document.getElementById('new-cat-display').value = '';
  document.getElementById('settings-alert').innerHTML = '';
}

function updatePending(input) {
  if (!pendingMappings) return;
  const id = input.dataset.id;
  if (pendingMappings[id]) pendingMappings[id].display = input.value;
}

function removeCatRow(id) {
  if (!pendingMappings) return;
  delete pendingMappings[id];
  const row = document.getElementById('row-' + id);
  if (row) row.remove();
}

function addCatMapping() {
  const id = document.getElementById('new-cat-id').value.trim();
  const original = document.getElementById('new-cat-original').value.trim();
  const display = document.getElementById('new-cat-display').value.trim();
  if (!id || !display) {
    document.getElementById('settings-alert').innerHTML =
      '<div class="alert alert-error" style="margin-top:0.75rem">Category ID and Display Name are required.</div>';
    return;
  }
  if (!pendingMappings) pendingMappings = {};
  pendingMappings[id] = { original, display };

  const list = document.getElementById('cat-editor-list');
  const row = document.createElement('div');
  row.className = 'cat-editor-row';
  row.id = 'row-' + id;
  row.innerHTML = `
    <span class="cat-id">#${id}</span>
    <span class="cat-original">${original || '(blank)'}</span>
    <input class="cat-name-input" type="text" value="${display}" data-id="${id}" oninput="updatePending(this)">
    <button class="delete-btn" onclick="removeCatRow(${id})">‚úï</button>`;
  list.appendChild(row);

  document.getElementById('new-cat-id').value = '';
  document.getElementById('new-cat-original').value = '';
  document.getElementById('new-cat-display').value = '';
  document.getElementById('settings-alert').innerHTML = '';
}

function saveCatMappings() {
  if (!pendingMappings) return;
  // Sync any inputs that may not have fired oninput
  document.querySelectorAll('.cat-name-input').forEach(inp => {
    if (pendingMappings[inp.dataset.id]) pendingMappings[inp.dataset.id].display = inp.value;
  });
  localStorage.setItem(NAMES_KEY, JSON.stringify(pendingMappings));
  document.getElementById('settings-alert').innerHTML =
    '<div class="alert alert-success" style="margin-top:0.75rem">‚úì Category names saved. They will apply to your next import.</div>';
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
renderDashboard();
</script>
</body>
</html>
